<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»é©ç†±ç—…åª’èšŠå­³ç”Ÿæºç¨½æŸ¥ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- è¢å¹•é¡¯ç¤ºæ¨£å¼ (Screen Style) --- */
        body { 
            background-color: #f0f2f5; 
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 80px; 
        }
        .container { max-width: 800px; margin-top: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { 
            background: linear-gradient(45deg, #198754, #20c997); 
            color: white; 
            font-weight: bold; 
            border-radius: 12px 12px 0 0 !important; 
            padding: 15px;
        }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .item-label { font-size: 0.95rem; color: #333; padding-right: 15px; line-height: 1.4; }
        .count-input { width: 80px; text-align: center; font-size: 1.2rem; font-weight: bold; border-radius: 8px; }
        
        /* åº•éƒ¨çµ±è¨ˆåˆ— */
        .summary-box {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* é™½æ€§åˆ—è¡¨æ¨£å¼ */
        .positive-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 10px; margin-bottom: 10px; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (Print Style) --- */
        @media print {
            body * { visibility: hidden; } /* éš±è—åŸæœ¬ç¶²é æ‰€æœ‰å…§å®¹ */
            #print-area, #print-area * { visibility: visible; } /* åªé¡¯ç¤ºåˆ—å°å€ */
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white; color: black;
            }
            .print-page {
                width: 100%; height: 100vh; page-break-after: always; /* å¼·åˆ¶åˆ†é  */
                padding: 20px; box-sizing: border-box;
            }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .print-table th, .print-table td { border: 1px solid black; padding: 6px; font-size: 14px; }
            .print-header { text-align: center; font-size: 22px; font-weight: bold; margin-bottom: 15px; }
            .print-footer { margin-top: 30px; display: flex; justify-content: space-between; font-size: 16px; }
            .signature-box { border-bottom: 1px solid black; width: 150px; display: inline-block; }
            
            /* èª¿æ•´æ¬„ä½å¯¬åº¦ä»¥ç¬¦åˆ PDF */
            .col-item { width: 75%; text-align: left; }
            .col-count { width: 25%; text-align: center; }
        }
        
        /* å¹³å¸¸éš±è—åˆ—å°å€ */
        #print-area { display: none; }
    </style>
</head>
<body>

<div class="container not-printable">
    <h3 class="text-center mb-4 fw-bold text-dark">ğŸ¦Ÿ ç™»é©ç†±ç—…åª’èšŠå­³ç”Ÿæº<br>ç¨½æŸ¥å›å ±èˆ‡ç®¡ç†ç³»çµ±</h3>

    <ul class="nav nav-pills nav-fill mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-bold" id="input-tab" data-bs-toggle="tab" data-bs-target="#input-panel">ğŸ“ ç¾å ´ç¨½æŸ¥èˆ‡é™½æ€§é»</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-panel">ğŸ” æˆæœæŸ¥è©¢èˆ‡å ±è¡¨</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="input-panel">
            <form id="inspectionForm">
                
                <div class="card">
                    <div class="card-header">ğŸ“ åŸºæœ¬è³‡æ–™</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label text-muted small">ç¨½æŸ¥æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="checkDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small">ç¨½æŸ¥åœ°é»</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select class="form-select" id="districtSelect" required onchange="updateVillages()"><option value="" disabled selected>é¸æ“‡å€</option></select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" id="villageSelect" required><option value="" disabled selected>é¸æ“‡é‡Œ</option></select>
                                    </div>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="detailAddress" placeholder="è©³ç´°åœ°é» (å¦‚: å…¬åœ’è·¯123è™Ÿ)" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small">ç¨½æŸ¥äººå“¡</label>
                                <input type="text" class="form-control" id="inspectorName" placeholder="å°å¼·/å°æ˜" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ä¸€ã€å®¤å¤–å †ç½®æˆ–å»¢æ£„å®¹å™¨</div>
                    <div class="card-body" id="part1_container"></div>
                </div>
                <div class="card">
                    <div class="card-header bg-secondary text-white">äºŒã€å®¤å…§å¤–ç©æ°´å®¹å™¨</div>
                    <div class="card-body" id="part2_container"></div>
                </div>

                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">ğŸ”¥ ç™»é©ç†±ç—…åª’èšŠé™½æ€§å­³ç”Ÿæºç´€éŒ„</div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">è‹¥ç™¼ç¾é™½æ€§å®¹å™¨æˆ–å­‘å­“ï¼Œè«‹åœ¨æ­¤æ–°å¢ç´€éŒ„ã€‚</p>
                        
                        <div id="positiveList">
                            </div>

                        <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#addPositiveModal">
                            â• æ–°å¢é™½æ€§é»
                        </button>
                    </div>
                </div>

                <div class="summary-box">
                    <div>
                        <small class="text-muted d-block">é™½æ€§åˆ¤å®š</small>
                        <span id="positiveStatus" class="fw-bold text-success">é™½æ€§å­³ç”Ÿæºç‚º 0</span>
                    </div>
                    <div class="text-end me-3">
                        <small class="text-muted d-block">åˆè¨ˆè™•æ•¸</small>
                        <span class="fw-bold">å»¢ <span id="totalWaste">0</span> / æ°´ <span id="totalWater">0</span></span>
                    </div>
                    <button type="submit" class="btn btn-primary fw-bold px-4">æäº¤</button>
                </div>
                <div style="height: 60px;"></div>
            </form>
        </div>

        <div class="tab-pane fade" id="query-panel">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">ğŸ” æ¢ä»¶ç¯©é¸</h5>
                    <div class="row g-2 align-items-end">
                        <div class="col-4">
                            <label class="small text-muted">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-4">
                            <label class="small text-muted">çµæŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-4">
                            <button class="btn btn-primary w-100" onclick="performQuery()">æŸ¥è©¢</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mb-2">
                <div class="form-check ms-2">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAll">å…¨é¸</label>
                </div>
                <button class="btn btn-dark btn-sm" onclick="printSelectedReports()">ğŸ–¨ï¸ ç”¢å‡ºé¸å–å ±è¡¨</button>
            </div>

            <div id="queryResults"></div>
            
            <div class="text-center mt-5">
                 <button class="btn btn-outline-secondary btn-sm" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPositiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">æ–°å¢é™½æ€§é»</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é•è¦å ´åŸŸ</label>
                    <select class="form-select" id="posPlace">
                        <option value="å±…å®¶å‘¨åœ">å±…å®¶å‘¨åœ</option>
                        <option value="å·¥åœ°">å·¥åœ°</option>
                        <option value="å­¸æ ¡">å­¸æ ¡</option>
                        <option value="èœåœ’">èœåœ’</option>
                        <option value="ç©ºåœ°">ç©ºåœ°</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">è©³ç´°åœ°å€/åœ°è™Ÿ</label>
                    <input type="text" class="form-control" id="posAddress" placeholder="è¼¸å…¥åœ°å€">
                </div>
                <div class="mb-3">
                    <label class="form-label">é™½æ€§æ¨£æ…‹</label>
                    <input type="text" class="form-control" id="posType" placeholder="ä¾‹ï¼šæ°´æ¡¶ã€èŠ±ç“¶ã€è¼ªèƒ">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="addPositiveRecord()">æ–°å¢</button>
            </div>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // è³‡æ–™çµæ§‹
    let tempPositiveList = []; // æš«å­˜ç›®å‰çš„é™½æ€§é»

    // å°å—å¸‚éƒ¨åˆ†å€åŸŸèˆ‡é‡Œåˆ¥ (ç¸®æ¸›ç‰ˆï¼Œå¯è‡ªè¡Œæ“´å……)
    const tainanData = {
        "åŒ—å€": ["åŒ—é–€é‡Œ", "å¤§å…‰é‡Œ", "å¤§æ¸¯é‡Œ", "å…¬åœ’é‡Œ", "é–‹å…ƒé‡Œ", "é•·æ¦®é‡Œ"],
        "æ±å€": ["å´‡å­¸é‡Œ", "å´‡æ˜é‡Œ", "æˆå¤§é‡Œ", "æ±é–€é‡Œ"],
        "ä¸­è¥¿å€": ["èµ¤åµŒé‡Œ", "å—é–€é‡Œ", "äº”æ¢æ¸¯é‡Œ"],
        "å®‰å¹³å€": ["å„„è¼‰é‡Œ", "å¹³é€šé‡Œ", "è‚²å¹³é‡Œ"],
        "æ°¸åº·å€": ["å¤§æ©‹é‡Œ", "å¾©èˆˆé‡Œ", "æ­£å¼·é‡Œ", "é¹½è¡Œé‡Œ"],
        "å—å€": ["é‡‘è¯é‡Œ", "æ–°èˆˆé‡Œ"]
    };

    const itemsPart1 = [
        "1. ç©ºç“¶ã€ç©ºç½â€¦ç­‰", "2. ç”•ã€å£º (é™¶ç“·æ°´ç¼¸ç­‰)", "3. é‹ã€å£ºã€å†·æ°£æ¥æ°´æ¡¶", 
        "4. æ¯å­ã€ç¢Ÿå­ã€ç›¤å­ã€ç¢—", "5. ç©ºä¿éº—é¾ã€é¦¬æ§½æ°´â€¦ç­‰", "6. æ¡¶å­ (éµæ¡¶ã€å¡‘è† æ¡¶)",
        "7. æ¤°å­æ®¼ã€æ¤°å­è‘‰æ²â€¦ç­‰", "8. å»¢è¼ªèƒ", "9. å»¢å‚¢ä¿±", "10. å»¢å¸†å¸ƒ", 
        "11. ç©ºåœ°æœªæ•´ç†", "12. ç©ºå±‹æœªæ•´ç†", "13. å…¶ä»– (ä»»ä½•å»¢æ£„å®¹å™¨)"
    ];

    const itemsPart2 = [
        "1. æ’èŠ±å®¹å™¨ (èŠ±ç›†ã€èŠ±ç“¶)", "2. è²¯æ°´å®¹å™¨ (ç¼¸ã€æ§½ã€æ¡¶)", "3. ç©æ°´çš„åœ°ä¸‹å®¤",
        "4. è¼ªèƒæˆ–æ’æ°´ç®¡ã€æ°´å¡”", "5. å†°ç®±é™¤éœœåº•ç›¤", "6. ç›†æ ½æ¤ç‰©å¢Šç›¤",
        "7. å…¶ä»– (ç«¹ç­’ã€æ¨¹æ´ã€æº)"
    ];

    window.onload = function() {
        generateFormFields('part1_container', itemsPart1, 'p1');
        generateFormFields('part2_container', itemsPart2, 'p2');
        initLocationSelect();
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkDate').value = today;
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
    };

    // --- 1. ä»‹é¢ç”Ÿæˆèˆ‡é‚è¼¯ ---

    function initLocationSelect() {
        const districtSelect = document.getElementById('districtSelect');
        Object.keys(tainanData).forEach(d => {
            const option = document.createElement('option');
            option.value = d; option.text = d;
            if(d==="åŒ—å€") option.selected = true;
            districtSelect.appendChild(option);
        });
        updateVillages();
    }

    function updateVillages() {
        const district = document.getElementById('districtSelect').value;
        const villageSelect = document.getElementById('villageSelect');
        const villages = tainanData[district] || [];
        villageSelect.innerHTML = '<option value="" disabled selected>é¸æ“‡é‡Œ</option>';
        villages.forEach(v => {
            const option = document.createElement('option');
            option.value = v; option.text = v;
            villageSelect.appendChild(option);
        });
    }

    function generateFormFields(containerId, items, prefix) {
        const container = document.getElementById(containerId);
        let html = '';
        items.forEach(item => {
            html += `
                <div class="item-row">
                    <label class="item-label">${item}</label>
                    <input type="number" class="form-control count-input" data-group="${prefix}" data-name="${item}" placeholder="0" inputmode="numeric" pattern="[0-9]*" onchange="calculateTotal()" onfocus="this.select()">
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function calculateTotal() {
        let totalWaste = 0;
        let totalWater = 0;
        document.querySelectorAll('input[data-group="p1"]').forEach(el => totalWaste += Number(el.value || 0));
        document.querySelectorAll('input[data-group="p2"]').forEach(el => totalWater += Number(el.value || 0));

        document.getElementById('totalWaste').innerText = totalWaste;
        document.getElementById('totalWater').innerText = totalWater;
        
        // åˆ¤å®šæ–‡å­—ç”±é™½æ€§é»é‚è¼¯æ±ºå®šï¼Œé€™è£¡åªæ›´æ–°æ•¸å­—
    }

    // --- 2. é™½æ€§é»åŠŸèƒ½ ---

    function addPositiveRecord() {
        const place = document.getElementById('posPlace').value;
        const address = document.getElementById('posAddress').value;
        const type = document.getElementById('posType').value;

        if(!address || !type) { alert("è«‹å¡«å¯«å®Œæ•´åœ°å€èˆ‡æ¨£æ…‹"); return; }

        tempPositiveList.push({ place, address, type });
        renderPositiveList();
        
        // Close modal
        const modalEl = document.getElementById('addPositiveModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        // Clear inputs
        document.getElementById('posAddress').value = '';
        document.getElementById('posType').value = '';
    }

    function renderPositiveList() {
        const container = document.getElementById('positiveList');
        const statusSpan = document.getElementById('positiveStatus');
        
        if (tempPositiveList.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-2">ç›®å‰ç„¡é™½æ€§é»è³‡æ–™</p>';
            statusSpan.innerText = "é™½æ€§å­³ç”Ÿæºç‚º 0";
            statusSpan.className = "fw-bold text-success";
        } else {
            let html = '';
            tempPositiveList.forEach((item, index) => {
                html += `
                    <div class="positive-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#${index+1} ${item.place}</strong><br>
                            <span class="small">${item.address} | ${item.type}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removePositive(${index})">åˆªé™¤</button>
                    </div>
                `;
            });
            container.innerHTML = html;
            statusSpan.innerText = "éœ€è¤‡æŸ¥ âš ï¸";
            statusSpan.className = "fw-bold text-danger";
        }
    }

    function removePositive(index) {
        tempPositiveList.splice(index, 1);
        renderPositiveList();
    }

    // --- 3. æäº¤èˆ‡å„²å­˜ ---

    document.getElementById('inspectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // æ”¶é›†ç’°å¢ƒç¨½æŸ¥æ•¸æ“š (éœ€ä¿ç•™è©³ç´°æ¯å€‹é …ç›®çš„æ•¸å€¼ä»¥ä¾¿åˆ—å°)
        let envData = [];
        document.querySelectorAll('.count-input').forEach(input => {
            if(input.value > 0) {
                envData.push({ name: input.getAttribute('data-name'), count: input.value, group: input.getAttribute('data-group') });
            }
        });

        const data = {
            id: Date.now(),
            date: document.getElementById('checkDate').value,
            district: document.getElementById('districtSelect').value,
            village: document.getElementById('villageSelect').value,
            address: document.getElementById('detailAddress').value,
            inspector: document.getElementById('inspectorName').value,
            wasteCount: document.getElementById('totalWaste').innerText,
            waterCount: document.getElementById('totalWater').innerText,
            positives: [...tempPositiveList], // è¤‡è£½ä¸€ä»½
            envDetails: envData // å„²å­˜æœ‰å¡«å¯«çš„é …ç›®ç´°ç¯€
        };

        let records = JSON.parse(localStorage.getItem('dengueRecords_v3')) || [];
        records.push(data);
        localStorage.setItem('dengueRecords_v3', JSON.stringify(records));

        alert("è³‡æ–™å·²å„²å­˜ï¼");
        
        // é‡ç½®è³‡æ–™ä½†ä¿ç•™éƒ¨åˆ†æ¬„ä½
        const currentDate = document.getElementById('checkDate').value;
        const currentInspector = document.getElementById('inspectorName').value;
        const currentDist = document.getElementById('districtSelect').value;
        const currentVill = document.getElementById('villageSelect').value;

        this.reset();
        tempPositiveList = [];
        renderPositiveList();

        document.getElementById('checkDate').value = currentDate;
        document.getElementById('inspectorName').value = currentInspector;
        document.getElementById('districtSelect').value = currentDist;
        updateVillages();
        document.getElementById('villageSelect').value = currentVill;
        calculateTotal();
    });

    // --- 4. æŸ¥è©¢èˆ‡å ±è¡¨ ---

    function performQuery() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const resultDiv = document.getElementById('queryResults');
        
        let records = JSON.parse(localStorage.getItem('dengueRecords_v3')) || [];
        // ä¾æ—¥æœŸç¯©é¸
        let filtered = records.filter(r => r.date >= start && r.date <= end);
        // æ–°åˆ°èˆŠæ’åº
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filtered.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning text-center">æŸ¥ç„¡è³‡æ–™</div>';
            return;
        }

        let html = '';
        filtered.forEach(r => {
            // åˆ¤æ–·ç‹€æ…‹
            const hasPositive = r.positives && r.positives.length > 0;
            const statusText = hasPositive ? `<span class="badge bg-danger">éœ€è¤‡æŸ¥ (${r.positives.length}é™½æ€§)</span>` : `<span class="badge bg-success">é™½æ€§ç‚º0</span>`;

            html += `
                <div class="card mb-2">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="me-3">
                            <input type="checkbox" class="form-check-input report-check" value="${r.id}" style="transform: scale(1.3);">
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-1">${r.date} <small class="text-muted">| ${r.district} ${r.village}</small></h6>
                                ${statusText}
                            </div>
                            <div class="small text-dark mb-1">ğŸ“ ${r.address} | ğŸ‘¤ ${r.inspector}</div>
                            <div class="small text-muted">
                                å»¢æ£„å®¹å™¨: ${r.wasteCount} | ç©æ°´å®¹å™¨: ${r.waterCount}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        resultDiv.innerHTML = html;
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.report-check').forEach(ck => ck.checked = checked);
    }

    // --- 5. åˆ—å°é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½) ---

    function printSelectedReports() {
        const checkboxes = document.querySelectorAll('.report-check:checked');
        if (checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸è¦åˆ—å°çš„è³‡æ–™"); return; }

        const allRecords = JSON.parse(localStorage.getItem('dengueRecords_v3')) || [];
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = ''; // æ¸…ç©ºåˆ—å°å€

        checkboxes.forEach(box => {
            const id = parseInt(box.value);
            const data = allRecords.find(r => r.id === id);
            if(data) {
                printArea.innerHTML += generatePrintPage(data);
            }
        });

        // è§¸ç™¼ç€è¦½å™¨åˆ—å°
        window.print();
    }

    // ç”¢ç”Ÿå–®é å ±è¡¨ HTML (ä¾ç…§ä¸Šå‚³çš„ç’°å¢ƒè¤‡æŸ¥è¡¨æ ¼å¼)
    function generatePrintPage(data) {
        // æº–å‚™å„é …ç›®çš„æ•¸å€¼ (å¾ envDetails æˆ–é è¨­ 0)
        const getCount = (itemName) => {
            const item = data.envDetails.find(i => i.name.startsWith(itemName));
            return item ? item.count : "";
        };

        // é™½æ€§é»åˆ—è¡¨å­—ä¸²åŒ–
        let positiveText = "";
        if (data.positives.length > 0) {
            positiveText = "<br><strong>[é™½æ€§å­³ç”Ÿæºç´€éŒ„]:</strong><br>";
            data.positives.forEach((p, i) => {
                positiveText += `${i+1}. ${p.place}-${p.type} (${p.address})<br>`;
            });
        }

        return `
        <div class="print-page">
            <div class="print-header">è‡ºå—å¸‚æ”¿åºœç™»é©ç†±ç—…åª’èšŠå­³ç”Ÿæºæª¢æŸ¥è¡¨</div>
            <div style="font-size: 16px; margin-bottom: 5px;">
                <strong>æª¢æŸ¥åœ°é»:</strong> ${data.district} ${data.village} ${data.address}
            </div>
            
            <table class="print-table">
                <thead>
                    <tr>
                        <th class="col-item">ä¸€ã€å®¤å¤–å †ç½®æˆ–å»¢æ£„ä¸‹åˆ—å®¹å™¨æˆ–é›œç‰©ï¼Œæœªæ¸…é™¤æˆ–æœªæ•´ç†ç¶­è­·</th>
                        <th class="col-count">æ•¸é‡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1. ç©ºç“¶ã€ç©ºç½...ç­‰</td><td class="text-center">${getCount("1.")}</td></tr>
                    <tr><td>2. ç”•ã€å£º (é™¶ç“·æ°´ç¼¸ç­‰)</td><td class="text-center">${getCount("2.")}</td></tr>
                    <tr><td>3. é‹ã€å£ºã€å†·æ°£æ¥æ°´æ¡¶</td><td class="text-center">${getCount("3.")}</td></tr>
                    <tr><td>4. æ¯å­ã€ç¢Ÿå­ã€ç›¤å­ã€ç¢—</td><td class="text-center">${getCount("4.")}</td></tr>
                    <tr><td>5. ç©ºä¿éº—é¾ã€é¦¬æ§½æ°´</td><td class="text-center">${getCount("5.")}</td></tr>
                    <tr><td>6. æ¡¶å­ (éµ/å¡‘è† æ¡¶)</td><td class="text-center">${getCount("6.")}</td></tr>
                    <tr><td>7. æ¤°å­æ®¼ã€æ¤°å­è‘‰æ²</td><td class="text-center">${getCount("7.")}</td></tr>
                    <tr><td>8. å»¢è¼ªèƒ</td><td class="text-center">${getCount("8.")}</td></tr>
                    <tr><td>9. å»¢å‚¢ä¿±</td><td class="text-center">${getCount("9.")}</td></tr>
                    <tr><td>10. å»¢å¸†å¸ƒ</td><td class="text-center">${getCount("10.")}</td></tr>
                    <tr><td>11. ç©ºåœ°æœªæ•´ç†</td><td class="text-center">${getCount("11.")}</td></tr>
                    <tr><td>12. ç©ºå±‹æœªæ•´ç†</td><td class="text-center">${getCount("12.")}</td></tr>
                    <tr><td>13. å…¶ä»–</td><td class="text-center">${getCount("13.")}</td></tr>
                    <tr>
                        <th class="col-item" style="background:#eee">äºŒã€å®¤å…§å¤–ç™¼ç¾ä¸‹åˆ—å®¹å™¨ã€é›œç‰©æˆ–å ´æ‰€ç©æ°´æœªæ´—åˆ·ä¹¾æ·¨</th>
                        <th class="col-count" style="background:#eee">æ•¸é‡</th>
                    </tr>
                    <tr><td>1. æ’èŠ±å®¹å™¨ (èŠ±ç›†ã€èŠ±ç“¶)</td><td class="text-center">${getCount("1.")}</td></tr>
                    <tr><td>2. è²¯æ°´å®¹å™¨ (æ°´ç¼¸ã€æ¡¶)</td><td class="text-center">${getCount("2.")}</td></tr>
                    <tr><td>3. ç©æ°´çš„åœ°ä¸‹å®¤</td><td class="text-center">${getCount("3.")}</td></tr>
                    <tr><td>4. è¼ªèƒæˆ–æ’æ°´ç®¡ã€æ°´å¡”</td><td class="text-center">${getCount("4.")}</td></tr>
                    <tr><td>5. å†°ç®±é™¤éœœåº•ç›¤</td><td class="text-center">${getCount("5.")}</td></tr>
                    <tr><td>6. ç›†æ ½æ¤ç‰©å¢Šç›¤</td><td class="text-center">${getCount("6.")}</td></tr>
                    <tr><td>7. å…¶ä»– (ç«¹ç­’ã€æºã€æ¨¹æ´)</td><td class="text-center">${getCount("7.")}</td></tr>
                </tbody>
            </table>

            <div style="margin-top: 10px; border: 1px solid black; padding: 10px;">
                <strong>ç¸½è¨ˆ:</strong> å»¢æ£„å®¹å™¨ ${data.wasteCount} è™• / ç©æ°´å®¹å™¨ ${data.waterCount} è™•
                ${positiveText}
            </div>

            <div class="print-footer">
                <div>
                    <div>ç’°ä¿/å…¬æ‰€æ©Ÿé—œæª¢æŸ¥äººç°½å:</div>
                    <div class="signature-box" style="height:50px;"></div>
                </div>
                <div>
                    <div>æª¢æŸ¥æ—¥æœŸ: ${data.date}</div>
                    <div style="margin-top:10px;">æª¢æŸ¥å“¡ç°½å: <span style="font-family:KV_OCR; font-size:18px;">${data.inspector}</span></div>
                </div>
            </div>
        </div>
        `;
    }

    function clearAllData() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºè³‡æ–™åº«å—ï¼Ÿ")) {
            localStorage.removeItem('dengueRecords_v3');
            document.getElementById('queryResults').innerHTML = '';
        }
    }
</script>

</body>
</html>
