<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»é©ç†±ç¨½æŸ¥å›å ±ç³»çµ± V8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ç¶²é ä»‹é¢æ¨£å¼ (è¢å¹•çœ‹å¾—åˆ°çš„) --- */
        body { background-color: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 100px; }
        .container { max-width: 800px; margin-top: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background: linear-gradient(45deg, #198754, #20c997); color: white; font-weight: bold; padding: 15px; border-radius: 12px 12px 0 0 !important; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .item-label { font-size: 0.95rem; color: #333; padding-right: 10px; line-height: 1.4; }
        .count-input { width: 70px; text-align: center; font-size: 1.2rem; font-weight: bold; border-radius: 8px; border: 1px solid #ced4da; }
        
        .summary-box { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 12px 20px; z-index: 1050; display: flex; justify-content: space-between; align-items: center; }

        .badge-tag { font-size: 0.95em; padding: 6px 12px; border-radius: 20px; margin: 4px; background-color: #e9ecef; color: #495057; display: inline-flex; align-items: center; border: 1px solid #ced4da;}
        .type-tags-container { display: flex; flex-wrap: wrap; align-content: flex-start; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (Print CSS) - æ ¸å¿ƒä¿®æ­£å€ --- */
        @media print {
            /* 1. é‡ç½®ç€è¦½å™¨åˆ—å°é è¨­å€¼ */
            @page { margin: 0; size: A4 portrait; }
            
            /* 2. éš±è—æ‰€æœ‰éåˆ—å°å€å…ƒç´  */
            body > *:not(#print-area) { display: none !important; }
            
            /* 3. é¡¯ç¤ºåˆ—å°å€ */
            #print-area { 
                display: block !important; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                background: white; 
                z-index: 9999; 
            }
            
            /* 4. å¼·åˆ¶åˆ†é è¨­å®š (ä½¿ç”¨ height: 100vh ç¢ºä¿ä½”æ»¿ä¸€é ) */
            .print-page { 
                width: 100%; 
                height: 100vh; /* é—œéµï¼šå¼·åˆ¶é«˜åº¦æ’æ»¿ä¸€é  */
                page-break-after: always; /* èˆŠç‰ˆç€è¦½å™¨ */
                break-after: page;        /* æ–°ç‰ˆç€è¦½å™¨ */
                padding: 1.5cm;           /* è¨­å®šé‚Šè· */
                box-sizing: border-box; 
                display: flex;            /* ä½¿ç”¨ Flexbox æ’ç‰ˆ */
                flex-direction: column;   /* å‚ç›´æ’åˆ— */
                justify-content: space-between; /* å…§å®¹é ä¸Šï¼Œé å°¾é ä¸‹ */
            }
            
            /* æœ€å¾Œä¸€é å–æ¶ˆåˆ†é ï¼Œé¿å…å¤šå‡ºä¸€å¼µç™½ç´™ */
            .print-page:last-child {
                page-break-after: auto;
                break-after: auto;
                height: auto; /* æœ€å¾Œä¸€é é«˜åº¦è‡ªå‹• */
                min-height: 100vh;
            }
            
            /* è¡¨æ ¼èˆ‡æ–‡å­—æ¨£å¼ */
            .check-table { width: 100%; border-collapse: collapse; font-family: "MingLiU", "PMingLiU", serif; }
            .check-table th, .check-table td { border: 1px solid #000; padding: 4px 8px; font-size: 14px; vertical-align: middle; }
            .check-header { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 10px; font-family: "BiauKai", "DFKai-SB", serif; }
            .section-title { background-color: #f0f0f0; font-weight: bold; text-align: left; }
            
            /* é é¢å…§å®¹å€ (è¡¨æ ¼) */
            .page-content { flex-grow: 1; }

            /* é å°¾/ç°½åå€ (å›ºå®šåœ¨åº•éƒ¨) */
            .page-footer { margin-top: 20px; }
            .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-family: "BiauKai", serif; font-size: 16px; }
            .sign-line { border-bottom: 1px solid #000; display: inline-block; width: 150px; height: 24px; }
            .result-box { margin-bottom: 15px; padding: 10px; border: 2px solid #000; font-size: 18px; font-family: "BiauKai", serif; font-weight: bold; }
        }
        
        #print-area { display: none; }
    </style>
</head>
<body>

<div class="container not-printable">
    <h3 class="text-center mb-4 fw-bold text-dark">ğŸ¦Ÿ ç™»é©ç†±ç—…åª’èšŠå­³ç”Ÿæº<br>ç¨½æŸ¥ç®¡ç†ç³»çµ±</h3>

    <ul class="nav nav-pills nav-fill mb-4">
        <li class="nav-item"><button class="nav-link active fw-bold" id="input-tab" data-bs-toggle="tab" data-bs-target="#input-panel">ğŸ“ ç¾å ´ç¨½æŸ¥èˆ‡é™½æ€§é»</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-panel">ğŸ” æˆæœæŸ¥è©¢èˆ‡åˆ—å°</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="input-panel">
            <form id="inspectionForm">
                <div class="card">
                    <div class="card-header">ğŸ“ åŸºæœ¬è³‡æ–™</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12"><label class="text-muted small">ç¨½æŸ¥æ—¥æœŸ</label><input type="date" class="form-control" id="checkDate" required></div>
                            <div class="col-12">
                                <label class="text-muted small">ç¨½æŸ¥åœ°é»</label>
                                <div class="row g-2">
                                    <div class="col-6"><select class="form-select" id="districtSelect" required onchange="updateVillages()"><option value="" disabled selected>é¸æ“‡å€</option></select></div>
                                    <div class="col-6"><select class="form-select" id="villageSelect" required><option value="" disabled selected>é¸æ“‡é‡Œ</option></select></div>
                                    <div class="col-12"><input type="text" class="form-control" id="detailAddress" placeholder="è©³ç´°åœ°å€" required></div>
                                </div>
                            </div>
                            <div class="col-12"><label class="text-muted small">ç¨½æŸ¥äººå“¡</label><input type="text" class="form-control" id="inspectorName" placeholder="å°å¼·/å°æ˜" required></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ä¸€ã€å®¤å¤–å †ç½®æˆ–å»¢æ£„å®¹å™¨</div>
                    <div class="card-body" id="part1_container"></div>
                </div>
                <div class="card">
                    <div class="card-header bg-secondary text-white">äºŒã€å®¤å…§å¤–ç©æ°´å®¹å™¨</div>
                    <div class="card-body" id="part2_container"></div>
                </div>

                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">ğŸ”¥ é™½æ€§å­³ç”Ÿæºç´€éŒ„ (éœ€è¤‡æŸ¥)</div>
                    <div class="card-body">
                        <div id="positiveList" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-danger w-100" onclick="openPositiveModal()">â• æ–°å¢é™½æ€§é»</button>
                    </div>
                </div>

                <div class="summary-box">
                    <div>
                        <small class="text-muted d-block">ç¸½é™½æ€§æ•¸</small>
                        <span id="totalPositiveDisplay" class="fw-bold text-success fs-5">0 è™•</span>
                    </div>
                    <div class="text-end me-3">
                        <small class="text-muted d-block">åˆè¨ˆè™•æ•¸</small>
                        <span class="fw-bold">å»¢ <span id="totalWaste">0</span> / æ°´ <span id="totalWater">0</span></span>
                    </div>
                    <button type="submit" class="btn btn-primary fw-bold px-4">æäº¤</button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="query-panel">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">ğŸ” æœå°‹æ¢ä»¶</h5>
                    <div class="mb-3">
                        <select class="form-select" id="queryType" onchange="toggleQueryInputs()">
                            <option value="date">ğŸ“… ä¾æ—¥æœŸå€é–“æŸ¥è©¢</option>
                            <option value="inspector">ğŸ‘¤ ä¾ç¨½æŸ¥å“¡å§“åæŸ¥è©¢</option>
                        </select>
                    </div>
                    <div id="dateQueryGroup" class="row g-2">
                        <div class="col-6"><label class="small text-muted">é–‹å§‹</label><input type="date" class="form-control" id="startDate"></div>
                        <div class="col-6"><label class="small text-muted">çµæŸ</label><input type="date" class="form-control" id="endDate"></div>
                    </div>
                    <div id="inspectorQueryGroup" class="d-none">
                         <input type="text" class="form-control" id="queryInspectorValue" placeholder="è¼¸å…¥å§“å (å¦‚: å°å¼·)">
                    </div>
                    <button class="btn btn-primary w-100 mt-3" onclick="performQuery()">æŸ¥è©¢</button>
                </div>
            </div>

            <div class="d-flex justify-content-between mb-2 align-items-center">
                <div class="form-check ms-2">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAll">å…¨é¸</label>
                </div>
                <button class="btn btn-dark btn-sm" onclick="printSelectedReports()">ğŸ–¨ï¸ åˆ—å°é¸å–å ±è¡¨</button>
            </div>

            <div id="queryResults"></div>
            <div class="text-center mt-5"><button class="btn btn-outline-secondary btn-sm" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPositiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">æ–°å¢é™½æ€§é»</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é•è¦å ´åŸŸ</label>
                    <select class="form-select" id="posPlace">
                        <option value="å±…å®¶å‘¨åœ">å±…å®¶å‘¨åœ</option>
                        <option value="å·¥åœ°">å·¥åœ°</option>
                        <option value="å­¸æ ¡">å­¸æ ¡</option>
                        <option value="èœåœ’">èœåœ’</option>
                        <option value="ç©ºåœ°">ç©ºåœ°</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label d-flex justify-content-between">
                        åœ°å€/åœ°è™Ÿ
                        <div class="form-check form-check-inline m-0">
                            <input class="form-check-input" type="checkbox" id="sameAddressCheck" onchange="copyAddress()">
                            <label class="form-check-label small text-primary" for="sameAddressCheck">ğŸ“ åŒç¨½æŸ¥åœ°é»</label>
                        </div>
                    </label>
                    <input type="text" class="form-control" id="posAddress" placeholder="è¼¸å…¥åœ°å€">
                </div>
                <div class="mb-3">
                    <label class="form-label">é™½æ€§æ¨£æ…‹èˆ‡æ•¸é‡</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="posTypeInput" placeholder="æ¨£æ…‹ (å¦‚:èŠ±ç“¶)" style="width: 50%;">
                        <input type="number" class="form-control" id="posCountInput" placeholder="æ•¸é‡" min="1" value="1" style="width: 25%;" inputmode="numeric" pattern="[0-9]*">
                        <button class="btn btn-outline-secondary" type="button" onclick="addTypeTag()">â• åŠ å…¥</button>
                    </div>
                    <div id="typeTagsContainer" class="p-2 border rounded bg-light type-tags-container" style="min-height: 50px;">
                        <span class="text-muted small fst-italic w-100" id="noTagsHint">è«‹è¼¸å…¥æ¨£æ…‹èˆ‡æ•¸é‡...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmAddPositive()">ç¢ºå®šæ–°å¢</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="msgModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center">
            <div class="modal-body p-4">
                <h5 class="fw-bold mb-3" id="msgTitle">æç¤º</h5>
                <p id="msgContent" class="mb-4"></p>
                <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">ç¢ºå®š</button>
            </div>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- è®Šæ•¸èˆ‡è³‡æ–™ ---
    let tempPositiveList = []; 
    let currentDetailedTypes = []; 

    const tainanData = {
        "åŒ—å€": ["åŒ—é–€é‡Œ", "å¤§å…‰é‡Œ", "å¤§æ¸¯é‡Œ", "å…¬åœ’é‡Œ", "é–‹å…ƒé‡Œ", "é•·æ¦®é‡Œ"],
        "æ±å€": ["å´‡å­¸é‡Œ", "å´‡æ˜é‡Œ", "æˆå¤§é‡Œ", "æ±é–€é‡Œ"],
        "ä¸­è¥¿å€": ["èµ¤åµŒé‡Œ", "å—é–€é‡Œ", "äº”æ¢æ¸¯é‡Œ"],
        "å®‰å¹³å€": ["å„„è¼‰é‡Œ", "å¹³é€šé‡Œ", "è‚²å¹³é‡Œ"],
        "æ°¸åº·å€": ["å¤§æ©‹é‡Œ", "å¾©èˆˆé‡Œ", "æ­£å¼·é‡Œ", "é¹½è¡Œé‡Œ"],
        "å—å€": ["é‡‘è¯é‡Œ", "æ–°èˆˆé‡Œ"]
    };

    const itemsPart1 = [
        "1. ç©ºç“¶ã€ç©ºç½â€¦ç­‰", "2. ç”•ã€å£º (é™¶ç“·æ°´ç¼¸ç­‰)", "3. é‹ã€å£ºã€å†·æ°£æ¥æ°´æ¡¶", 
        "4. æ¯å­ã€ç¢Ÿå­ã€ç›¤å­ã€ç¢—", "5. ç©ºä¿éº—é¾ã€é¦¬æ§½æ°´â€¦ç­‰", "6. æ¡¶å­ (éµæ¡¶ã€å¡‘è† æ¡¶)",
        "7. æ¤°å­æ®¼ã€æ¤°å­è‘‰æ²â€¦ç­‰", "8. å»¢è¼ªèƒ", "9. å»¢å‚¢ä¿±", "10. å»¢å¸†å¸ƒ", 
        "11. ç©ºåœ°æœªæ•´ç†", "12. ç©ºå±‹æœªæ•´ç†", "13. å…¶ä»–"
    ];

    const itemsPart2 = [
        "1. æ’èŠ±å®¹å™¨ (èŠ±ç›†ã€èŠ±ç“¶)", "2. è²¯æ°´å®¹å™¨ (ç¼¸ã€æ§½ã€æ¡¶)", "3. ç©æ°´çš„åœ°ä¸‹å®¤",
        "4. è¼ªèƒæˆ–æ’æ°´ç®¡ã€æ°´å¡”", "5. å†°ç®±é™¤éœœåº•ç›¤", "6. ç›†æ ½æ¤ç‰©å¢Šç›¤",
        "7. å…¶ä»– (ç«¹ç­’ã€æ¨¹æ´ã€æº)"
    ];

    window.onload = function() {
        generateFormFields('part1_container', itemsPart1, 'p1');
        generateFormFields('part2_container', itemsPart2, 'p2');
        initLocationSelect();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkDate').value = today;
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
    };

    function showMsg(title, content) {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgContent').innerText = content;
        new bootstrap.Modal(document.getElementById('msgModal')).show();
    }

    // --- 1. ä»‹é¢èˆ‡è¨ˆç®— ---
    function initLocationSelect() {
        const districtSelect = document.getElementById('districtSelect');
        Object.keys(tainanData).forEach(d => {
            const option = document.createElement('option');
            option.value = d; option.text = d;
            if(d==="åŒ—å€") option.selected = true;
            districtSelect.appendChild(option);
        });
        updateVillages();
    }

    function updateVillages() {
        const district = document.getElementById('districtSelect').value;
        const villageSelect = document.getElementById('villageSelect');
        const villages = tainanData[district] || [];
        villageSelect.innerHTML = '<option value="" disabled selected>é¸æ“‡é‡Œ</option>';
        villages.forEach(v => {
            const option = document.createElement('option');
            option.value = v; option.text = v;
            villageSelect.appendChild(option);
        });
    }

    function generateFormFields(containerId, items, prefix) {
        const container = document.getElementById(containerId);
        let html = '';
        items.forEach(item => {
            html += `
                <div class="item-row">
                    <label class="item-label">${item}</label>
                    <input type="number" class="form-control count-input" data-group="${prefix}" data-name="${item}" placeholder="0" inputmode="numeric" pattern="[0-9]*" onchange="calculateTotal()" onfocus="this.select()">
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function calculateTotal() {
        let totalWaste = 0;
        let totalWater = 0;
        document.querySelectorAll('input[data-group="p1"]').forEach(el => totalWaste += Number(el.value || 0));
        document.querySelectorAll('input[data-group="p2"]').forEach(el => totalWater += Number(el.value || 0));
        document.getElementById('totalWaste').innerText = totalWaste;
        document.getElementById('totalWater').innerText = totalWater;
    }

    // --- 2. é™½æ€§é» ---
    function getModalInstance() {
        return bootstrap.Modal.getOrCreateInstance(document.getElementById('addPositiveModal'));
    }

    function openPositiveModal() {
        document.getElementById('posPlace').value = 'å±…å®¶å‘¨åœ';
        document.getElementById('posAddress').value = '';
        document.getElementById('sameAddressCheck').checked = false;
        document.getElementById('posTypeInput').value = '';
        document.getElementById('posCountInput').value = '1';
        currentDetailedTypes = [];
        renderTypeTags();
        getModalInstance().show();
    }

    function copyAddress() {
        if (document.getElementById('sameAddressCheck').checked) {
            const dist = document.getElementById('districtSelect').value;
            const vill = document.getElementById('villageSelect').value || "";
            const detail = document.getElementById('detailAddress').value;
            if(!dist) { 
                showMsg("æç¤º", "è«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™åœ°é»"); 
                document.getElementById('sameAddressCheck').checked = false; 
                return; 
            }
            document.getElementById('posAddress').value = `${dist}${vill}${detail}`;
        } else {
            document.getElementById('posAddress').value = '';
        }
    }

    function addTypeTag() {
        const t = document.getElementById('posTypeInput').value.trim();
        const c = parseInt(document.getElementById('posCountInput').value) || 1;
        if (t) {
            currentDetailedTypes.push({ type: t, count: c });
            renderTypeTags();
            document.getElementById('posTypeInput').value = '';
            document.getElementById('posCountInput').value = '1';
            document.getElementById('posTypeInput').focus();
        }
    }

    function renderTypeTags() {
        const container = document.getElementById('typeTagsContainer');
        container.innerHTML = ''; 
        if (currentDetailedTypes.length > 0) {
            currentDetailedTypes.forEach((item, index) => {
                const tag = document.createElement('span');
                tag.className = 'badge-tag';
                tag.innerHTML = `${item.type} <span class="badge bg-secondary rounded-pill ms-1">${item.count}</span> <span style="cursor:pointer; margin-left:8px; color:#999;" onclick="removeTypeTag(${index})">&times;</span>`;
                container.appendChild(tag);
            });
        } else {
             container.innerHTML = '<span class="text-muted small fst-italic w-100" id="noTagsHint">è«‹è¼¸å…¥æ¨£æ…‹èˆ‡æ•¸é‡...</span>';
        }
    }

    function removeTypeTag(index) {
        currentDetailedTypes.splice(index, 1);
        renderTypeTags();
    }

    function confirmAddPositive() {
        const place = document.getElementById('posPlace').value;
        const address = document.getElementById('posAddress').value;
        if(!address) { showMsg("éŒ¯èª¤", "è«‹å¡«å¯«åœ°å€"); return; }
        if(currentDetailedTypes.length === 0) { showMsg("éŒ¯èª¤", "è«‹è‡³å°‘æ–°å¢ä¸€é …"); return; }

        tempPositiveList.push({ place, address, detailedTypes: [...currentDetailedTypes] });
        renderPositiveList();
        getModalInstance().hide();
    }

    function renderPositiveList() {
        const container = document.getElementById('positiveList');
        const display = document.getElementById('totalPositiveDisplay');
        let totalCount = 0;
        let html = '';
        tempPositiveList.forEach((item, index) => {
            let subTotal = 0;
            let typeStrArr = [];
            item.detailedTypes.forEach(d => {
                subTotal += d.count;
                typeStrArr.push(`${d.type}*${d.count}`);
            });
            totalCount += subTotal;
            html += `
                <div class="alert alert-warning d-flex justify-content-between align-items-center p-2 mb-2">
                    <div>
                        <strong>${index+1}. ${item.place}</strong> <small class="text-muted">(${item.address})</small><br>
                        <span class="small text-danger">${typeStrArr.join("ã€")}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="removePositive(${index})">åˆªé™¤</button>
                </div>
            `;
        });
        container.innerHTML = html || '<p class="text-muted text-center py-2">ç›®å‰ç„¡ç´€éŒ„</p>';
        
        if(totalCount > 0) {
            display.innerText = `${totalCount} è™• âš ï¸`;
            display.className = "fw-bold text-danger fs-5";
        } else {
            display.innerText = "0 è™•";
            display.className = "fw-bold text-success fs-5";
        }
    }

    function removePositive(index) {
        tempPositiveList.splice(index, 1);
        renderPositiveList();
    }

    // --- 3. æäº¤ ---
    document.getElementById('inspectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        let envData = [];
        document.querySelectorAll('.count-input').forEach(input => {
            envData.push({ name: input.getAttribute('data-name'), count: input.value, group: input.getAttribute('data-group') });
        });

        let totalPos = 0;
        tempPositiveList.forEach(p => p.detailedTypes.forEach(d => totalPos += d.count));

        const data = {
            id: Date.now(),
            date: document.getElementById('checkDate').value,
            district: document.getElementById('districtSelect').value,
            village: document.getElementById('villageSelect').value,
            address: document.getElementById('detailAddress').value,
            inspector: document.getElementById('inspectorName').value,
            wasteCount: document.getElementById('totalWaste').innerText,
            waterCount: document.getElementById('totalWater').innerText,
            totalPositiveCount: totalPos,
            positives: [...tempPositiveList],
            envDetails: envData
        };

        let records = JSON.parse(localStorage.getItem('dengueRecords_v7')) || [];
        records.push(data);
        localStorage.setItem('dengueRecords_v7', JSON.stringify(records));
        showMsg("æˆåŠŸ", "è³‡æ–™å·²å„²å­˜ï¼");
        
        const backupDate = document.getElementById('checkDate').value;
        const backupInsp = document.getElementById('inspectorName').value;
        const backupDist = document.getElementById('districtSelect').value;
        const backupVill = document.getElementById('villageSelect').value;

        this.reset();
        tempPositiveList = [];
        renderPositiveList();
        
        document.getElementById('checkDate').value = backupDate;
        document.getElementById('inspectorName').value = backupInsp;
        document.getElementById('districtSelect').value = backupDist;
        updateVillages();
        document.getElementById('villageSelect').value = backupVill;
        calculateTotal();
    });

    // --- 4. æŸ¥è©¢ ---
    function toggleQueryInputs() {
        const type = document.getElementById('queryType').value;
        const dateGroup = document.getElementById('dateQueryGroup');
        const inspectorGroup = document.getElementById('inspectorQueryGroup');
        if (type === 'date') {
            dateGroup.classList.remove('d-none');
            inspectorGroup.classList.add('d-none');
        } else {
            dateGroup.classList.add('d-none');
            inspectorGroup.classList.remove('d-none');
        }
    }

    function performQuery() {
        const type = document.getElementById('queryType').value;
        const resultDiv = document.getElementById('queryResults');
        let records = JSON.parse(localStorage.getItem('dengueRecords_v7')) || [];
        let filtered = [];

        if (type === 'date') {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            filtered = records.filter(r => r.date >= start && r.date <= end);
        } else {
            const val = document.getElementById('queryInspectorValue').value.trim();
            filtered = records.filter(r => r.inspector.includes(val));
        }
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filtered.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning text-center">æŸ¥ç„¡è³‡æ–™</div>';
            return;
        }

        let html = '';
        filtered.forEach(r => {
            let pCount = r.totalPositiveCount !== undefined ? r.totalPositiveCount : 0;
            const statusBadge = pCount > 0 
                ? `<span class="badge bg-danger">é™½æ€§: ${pCount}</span>` 
                : `<span class="badge bg-success">é™½æ€§: 0</span>`;

            html += `
                <div class="card mb-2">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="me-3">
                            <input type="checkbox" class="form-check-input report-check" value="${r.id}" style="transform: scale(1.3);">
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-1">${r.date} | ${r.district}${r.village}</h6>
                                ${statusBadge}
                            </div>
                            <div class="small text-muted mb-2">${r.address} (ç¨½æŸ¥å“¡: ${r.inspector})</div>
                            <div class="d-flex gap-2">
                                <span class="badge bg-light text-dark border">å»¢æ£„: ${r.wasteCount}</span>
                                <span class="badge bg-light text-dark border">ç©æ°´: ${r.waterCount}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        resultDiv.innerHTML = html;
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.report-check').forEach(ck => ck.checked = checked);
    }

    function printSelectedReports() {
        const checkboxes = document.querySelectorAll('.report-check:checked');
        if (checkboxes.length === 0) { showMsg("æç¤º", "è«‹å‹¾é¸è¦åˆ—å°çš„è³‡æ–™"); return; }
        const allRecords = JSON.parse(localStorage.getItem('dengueRecords_v7')) || [];
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = ''; 

        checkboxes.forEach(box => {
            const data = allRecords.find(r => r.id === parseInt(box.value));
            if(data) printArea.innerHTML += generatePrintHtml(data);
        });
        setTimeout(() => window.print(), 500);
    }

    // æ ¸å¿ƒä¿®æ­£ï¼šå ±è¡¨ç”Ÿæˆé‚è¼¯ (ä½¿ç”¨ Flexbox ç‰ˆé¢æ§åˆ¶)
    function generatePrintHtml(data) {
        const getCountByFullName = (fullName) => {
            const found = data.envDetails.find(i => i.name === fullName);
            return (found && found.count > 0) ? found.count : "";
        };

        const pCount = data.totalPositiveCount || 0;

        // ç”Ÿæˆ Part 1 è¡¨æ ¼è¡Œ
        let rowsPart1 = "";
        itemsPart1.forEach(item => {
            const val = getCountByFullName(item);
            rowsPart1 += `<tr><td>${item}</td><td class="text-center">${val}</td></tr>`;
        });

        // ç”Ÿæˆ Part 2 è¡¨æ ¼è¡Œ
        let rowsPart2 = "";
        itemsPart2.forEach(item => {
            const val = getCountByFullName(item);
            rowsPart2 += `<tr><td>${item}</td><td class="text-center">${val}</td></tr>`;
        });

        // Page 1
        let page1 = `
        <div class="print-page">
            <div class="page-content">
                <div class="check-header">è‡ºå—å¸‚æ”¿åºœç™»é©ç†±ç—…åª’èšŠå­³ç”Ÿæºæª¢æŸ¥è¡¨</div>
                <div style="font-size: 16px; margin-bottom: 5px;">
                    <strong>æª¢æŸ¥åœ°é»:</strong> ${data.district} ${data.village} ${data.address}
                </div>
                
                <table class="check-table">
                    <thead>
                        <tr>
                            <th style="width: 75%; text-align: left;">ä¸€ã€å®¤å¤–å †ç½®æˆ–å»¢æ£„ä¸‹åˆ—å®¹å™¨æˆ–é›œç‰©ï¼Œæœªæ¸…é™¤æˆ–æœªæ•´ç†ç¶­è­·</th>
                            <th style="width: 25%;">è™•</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsPart1}
                        <tr class="section-title"><td colspan="2">äºŒã€å®¤å…§å¤–ç™¼ç¾ä¸‹åˆ—å®¹å™¨ã€é›œç‰©æˆ–å ´æ‰€ç©æ°´æœªæ´—åˆ·ä¹¾æ·¨</td></tr>
                        ${rowsPart2}
                    </tbody>
                </table>
                <div style="margin-top: 10px; border: 1px solid black; padding: 10px;">
                    <span><strong>ç¸½è¨ˆ:</strong> å»¢æ£„å®¹å™¨ ${data.wasteCount} è™• / ç©æ°´å®¹å™¨ ${data.waterCount} è™•</span>
                </div>
            </div>

            <div class="page-footer">
                <div class="footer-grid">
                    <div>
                        <div>ç’°ä¿æ©Ÿé—œ/å…¬æ‰€æ©Ÿé—œæª¢æŸ¥äººç°½å:</div>
                        <div class="sign-line" style="margin-top:35px;"></div>
                    </div>
                    <div>
                        <div>æª¢æŸ¥æ—¥æœŸ: ${data.date}</div>
                        <div style="margin-top:10px;">ç¨½æŸ¥äººå“¡å§“å: ${data.inspector}</div>
                        <div style="margin-top:10px;">ç¨½æŸ¥äººå“¡ç°½å: <div class="sign-line"></div></div>
                    </div>
                </div>
            </div>
        </div>
        `;

        // Page 2
        let page2 = "";
        if (pCount > 0) {
            let rows = "";
            let itemIndex = 1;
            
            data.positives.forEach(p => {
                p.detailedTypes.forEach(d => {
                    rows += `
                        <tr>
                            <td class="text-center">${itemIndex++}</td>
                            <td>${p.place}</td>
                            <td>${p.address}</td>
                            <td>${d.type} (æ•¸é‡: ${d.count})</td>
                        </tr>
                    `;
                });
            });

            for(let i=itemIndex; i<=10; i++) {
                rows += `<tr><td>${i}</td><td></td><td></td><td></td></tr>`;
            }

            page2 = `
            <div class="print-page">
                <div class="page-content">
                    <div class="check-header">ç™»é©ç†±ç—…åª’èšŠé™½æ€§å­³ç”Ÿæºç´€éŒ„è¡¨</div>
                    <div style="font-size: 16px; margin-bottom: 5px;">
                         <strong>è¡Œæ”¿å€:</strong> ${data.district} ${data.village}
                    </div>
                    <table class="check-table">
                        <thead>
                            <tr style="background:#eee;">
                                <th style="width:10%">é™½æ€§é»</th>
                                <th style="width:20%">é•è¦å ´åŸŸ</th>
                                <th style="width:40%">åœ°å€ (æˆ–åœ°è™Ÿ)</th>
                                <th style="width:30%">é™½æ€§æ¨£æ…‹ (å®¹å™¨ç¨®é¡)</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    
                    <div class="result-box">
                        é™½æ€§å­³ç”Ÿæºå…± ${pCount} è™•ï¼Œåˆ¤å®šï¼šå¾…è¤‡æŸ¥
                    </div>
                </div>

                <div class="page-footer">
                    <div class="footer-grid">
                         <div>è£½è¡¨æ—¥æœŸ: ${data.date}</div>
                         <div>ç¨½æŸ¥å“¡: ${data.inspector}</div>
                    </div>
                </div>
            </div>
            `;
        }
        return page1 + page2;
    }

    function clearAllData() {
        if(confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) {
            localStorage.removeItem('dengueRecords_v7');
            document.getElementById('queryResults').innerHTML = '';
        }
    }
</script>

</body>
</html>
